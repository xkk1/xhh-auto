<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>页面截图</title>
    <link rel="stylesheet" href="./css/通用样式.css">
</head>
<body>
    <main>
        <p style="text-align: center;">
            <button type="button" id="获取截图" style="font-size: 1.2rem;">获取<span id="页面名"></span>页面截图</button>
        </p>
        <p style="display: flex; flex-wrap: wrap; gap: 1rem;">
            <span class="不换行">
                <label for="类型">类型</label>
                <select id="类型">
                    <option value="png">png</option>
                    <option value="jpeg" selected>jpeg</option>
                </select>
            </span>
            <span class="不换行">
                <label for="缩放">缩放</label>
                <select id="缩放">
                    <option value="css" selected>CSS</option>
                    <option value="device">设备(dpi)</option>
                </select>
            </span>
            <span class="不换行">
                <input type="checkbox" id="全屏" />
                <label for="全屏">截全屏</label>
            </span>
            <span class="不换行">
                <input type="checkbox" id="下载" />
                <label for="下载">链接触发下载</label>
            </span>
        </p>
        <p>
            <span class="不换行"></span>
                <input type="checkbox" id="保存本地" />
                <label for="保存本地">保存本地：</label>
            <span class="不换行"></span>
            <input type="text" id="路径" placeholder="数据/截图.jpeg"  disabled="" />
        </p>
        <pre id="错误信息" style="color: red;"></pre>
        <p style="text-align: center;">
            <!-- 空 img 用来接收图片 -->
            <img src="" alt="页面截图" id="页面截图" style="display: none;" />
        </p>
        <p>
            实时截图链接:<a href="#" target="_blank" id="截图URL元素"></a>
        </p>
    </main>
    <style>
#获取截图.加载中::before {
    content: "正在";
}
#获取截图.加载中::after {
    content: "中...";
}
#页面截图 {
    max-width: 100%;
    max-height: 100vh;
}
.不换行 {
    white-space: nowrap;
}
    </style>
    <script>
// 获取当前 URL 的查询字符串部分，并解析
const urlParams = new URLSearchParams(window.location.search);
const pageName = urlParams.get('页面名') || '页面名';
document.getElementById('页面名').textContent = pageName;
const 错误信息元素 = document.getElementById('错误信息');
const 获取截图按钮 = document.getElementById('获取截图');
const 页面截图元素 = document.getElementById('页面截图');
const 截图URL元素 = document.getElementById('截图URL元素');
const 类型元素 = document.getElementById('类型');
const 缩放元素 = document.getElementById('缩放');
const 全屏元素 = document.getElementById('全屏');
const 下载元素 = document.getElementById('下载');
const 保存本地元素 = document.getElementById('保存本地');
const 路径元素 = document.getElementById('路径');
// 禁用 路径元素
保存本地元素.addEventListener('change', () => {
    路径元素.disabled = !保存本地元素.checked;
});
类型元素.addEventListener('change', () => {
    路径元素.setAttribute('placeholder', `数据/截图.${类型元素.value}`);
});

function 获取截图URL() {
    const baseUrl = '/api/脚本/路由/小红狐截图/api/页面操作/页面截图';
    const params = new URLSearchParams({
        "页面名": pageName,
        "类型": 类型元素.value,
        "缩放": 缩放元素.value,
    });
    if (全屏元素.checked) {
        params.append("全屏", ""); // 或直接 params.set("全屏", "")，甚至只写 params.append("全屏")
    }
    if (下载元素.checked) {
        params.append("下载", "");
    }
    if (保存本地元素.checked) {
        params.append("路径", 路径元素.value || '数据/截图.' + 类型元素.value);
    }
    const url = baseUrl + '?' + params.toString();
    截图URL元素.href = url;
    截图URL元素.textContent = decodeURIComponent(url);
    return url;
}
[类型元素, 缩放元素, 全屏元素, 下载元素, 保存本地元素, 路径元素].forEach(element => {
    element.addEventListener('change', () => {
        截图URL = 获取截图URL();
    });
});
let 截图URL = 获取截图URL();
获取截图按钮.onclick = () => {
    获取截图按钮.classList.add('加载中');
    错误信息元素.textContent = '';
    fetch(截图URL)
    .then(res => {
        if (!res.ok) {
            // 显示错误信息
            res.text().then(text => {
                错误信息元素.textContent = text;
            });
            throw new Error(res.statusText);
        }
        return res.blob();
    })
    .then(data => {
        页面截图元素.src = URL.createObjectURL(data);
        页面截图元素.style.display = '';
    })
    .catch(err => {
        console.error(err);
    })
    .finally(() => {
        获取截图按钮.classList.remove('加载中');
    });
};
    </script>
</body>
</html>