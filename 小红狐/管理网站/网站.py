import asyncio
import os
from pathlib import Path
import socket
import webbrowser

from flask import Flask
from waitress import serve

from ..å·¥å…·.æ—¥å¿—å·¥å…· import è·å–æ—¥å¿—è®°å½•å™¨
from ..å·¥å…·.ä»»åŠ¡ç®¡ç†å™¨å·¥å…· import å¼‚æ­¥ä»»åŠ¡ç®¡ç†å™¨
from ..æ ¸å¿ƒ.å°çº¢ç‹é…ç½® import è·å–è°ƒè¯•, è·å–ç®¡ç†ç½‘ç«™ç«¯å£, è·å–è‡ªåŠ¨æ‰“å¼€ç®¡ç†ç½‘ç«™
from . import ç½‘ç«™ç›®å½•, é™æ€æ–‡ä»¶ç›®å½•, æ¨¡æ¿ç›®å½•


æ—¥å¿— = è·å–æ—¥å¿—è®°å½•å™¨(__name__)
è°ƒè¯• = è·å–è°ƒè¯•()
ç«¯å£ = è·å–ç®¡ç†ç½‘ç«™ç«¯å£()
è‡ªåŠ¨æ‰“å¼€ç®¡ç†ç½‘ç«™ = è·å–è‡ªåŠ¨æ‰“å¼€ç®¡ç†ç½‘ç«™()


def æ£€æµ‹ç«¯å£å ç”¨(ç«¯å£: int) -> bool:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        try:
            s.bind(("0.0.0.0", ç«¯å£))  # æˆ–è€…ä½¿ç”¨ "127.0.0.1" ä»…æœ¬åœ°
            return False
        except OSError as e:
            æ—¥å¿—.ä¿¡æ¯(f"æ£€æµ‹ç«¯å£ {ç«¯å£} å ç”¨ï¼Œé”™è¯¯ï¼š{e}")
            return True  # ç«¯å£å·²è¢«å ç”¨

async def æµè§ˆå™¨æ‰“å¼€ç®¡ç†ç½‘ç«™(ç«¯å£: int):
    from ..æ ¸å¿ƒ.å°çº¢ç‹é…ç½® import è·å–ç®¡ç†ç½‘ç«™æ‰“å¼€å»¶è¿Ÿ
    ç®¡ç†ç½‘ç«™æ‰“å¼€å»¶è¿Ÿ = è·å–ç®¡ç†ç½‘ç«™æ‰“å¼€å»¶è¿Ÿ()
    æ—¥å¿—.ä¿¡æ¯(f"ğŸš€ç®¡ç†ç½‘ç«™å·²å¯åŠ¨ï¼Œè¯·ç­‰å¾… {ç®¡ç†ç½‘ç«™æ‰“å¼€å»¶è¿Ÿ} ç§’åè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨")
    await asyncio.sleep(ç®¡ç†ç½‘ç«™æ‰“å¼€å»¶è¿Ÿ)
    webbrowser.open(f"http://localhost:{ç«¯å£}")

def ä¸»å‡½æ•°():
    æ—¥å¿—.è°ƒè¯•(f"ğŸŒˆçº¢ç‹ç®¡ç†ç½‘ç«™å¯åŠ¨ä¸­ï¼Œç½‘ç«™ç›®å½•ï¼š{str(ç½‘ç«™ç›®å½•)}")
    ç½‘ç«™ = Flask(
        __name__,
        static_folder=é™æ€æ–‡ä»¶ç›®å½•,
        static_url_path="",
        template_folder=æ¨¡æ¿ç›®å½•
        )

    # æ³¨å†Œè“å›¾
    from .è·¯ç”±.ä¸»é¡µ import ä¸»é¡µè“å›¾
    ç½‘ç«™.register_blueprint(ä¸»é¡µè“å›¾)
    from .è·¯ç”±.api import apiè“å›¾
    ç½‘ç«™.register_blueprint(apiè“å›¾)
    
    if æ£€æµ‹ç«¯å£å ç”¨(ç«¯å£):
        raise Exception(f"âŒç«¯å£ {ç«¯å£} å·²è¢«å ç”¨ï¼Œè¯·é€‰æ‹©å…¶ä»–ç«¯å£")
    æ—¥å¿—.ä¿¡æ¯(f"ğŸ”¨ç®¡ç†ç½‘ç«™å¯åŠ¨ä¸­ï¼Œç«¯å£ï¼š{ç«¯å£}ï¼Œè°ƒè¯•ï¼š{è°ƒè¯•}")
    if è‡ªåŠ¨æ‰“å¼€ç®¡ç†ç½‘ç«™:
        å¼‚æ­¥ä»»åŠ¡ç®¡ç†å™¨.å¯åŠ¨ä»»åŠ¡(ä»»åŠ¡åç§°="æµè§ˆå™¨æ‰“å¼€ç®¡ç†ç½‘ç«™", åç¨‹=æµè§ˆå™¨æ‰“å¼€ç®¡ç†ç½‘ç«™(ç«¯å£=ç«¯å£))
    if è°ƒè¯•:
        # ä¸å¯ç”¨ use_reloader=Trueï¼Œé‡è½½ä¼šå¯¼è‡´æµè§ˆå™¨é‡å¼€å¤šå¼€
        ç½‘ç«™.run(host="0.0.0.0", port=ç«¯å£, debug=True, use_reloader=False)
    else:
        serve(ç½‘ç«™, host="0.0.0.0", port=ç«¯å£)
